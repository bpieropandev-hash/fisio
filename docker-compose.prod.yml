version: '3.8'

services:
  # Aplicação Spring Boot
  physio-manager:
    build:
      context: .
      dockerfile: Dockerfile
    image: physio-manager:latest
    container_name: physio-manager-prod
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database (banco externo - configure no .env)
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      
      # JPA
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO:-validate}
      - SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA=${SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA:-master}
      - SPRING_JPA_PROPERTIES_HIBERNATE_JDBC_TIME_ZONE=${SPRING_JPA_PROPERTIES_HIBERNATE_JDBC_TIME_ZONE:-America/Sao_Paulo}
      
      # Hikari Connection Pool
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=${SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE:-20}
      - SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE=${SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE:-10}
      
      # Logging
      - LOGGING_LEVEL_COM_PHYSIO=${LOGGING_LEVEL_COM_PHYSIO:-INFO}
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=${LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB:-WARN}
      - LOGGING_LEVEL_ORG_HIBERNATE_SQL=${LOGGING_LEVEL_ORG_HIBERNATE_SQL:-WARN}
      
      # Security
      - API_SECURITY_TOKEN_SECRET=${API_SECURITY_TOKEN_SECRET}
      
      # Profile
      - SPRING_PROFILES_ACTIVE=prod
      
      # Java Options
      - JAVA_OPTS=${JAVA_OPTS:--Xmx1024m -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200}
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/swagger-ui.html || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

